from bs4 import BeautifulSoup as bs
import os
import pandas as pd
import re
import csv
import io

result = {}
new = {}
id = 0
'''
result = {id:{'title':' ', 'abstract':' ', 'key_wordsZ':{'a','b','c'}, 'key_wordsE':{'a','b','c'},'authors': {'author1'}   }}

'''
p = os.walk('知网html')  # html文件夹路径
output_route = '../output/'

with open(output_route + "中文关键词.csv", "w", newline='') as csvfile:  # 写csv文件表头
    writer = csv.writer(csvfile)
    writer.writerow(['title', 'key_words'])

with open(output_route + "英文关键词.csv", "w", newline='') as csvfile:  # 写csv文件表头
    writer = csv.writer(csvfile)
    writer.writerow(['title', 'key_words'])
with open(output_route + "作者.csv", "w", newline='') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(['title', 'authors'])
with open(output_route + "标题摘要.csv", "w", newline='') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow(['title', 'abstract'])



for path, dir_list, file_list in p:
    for file_name in file_list:
        print(file_name)
        if file_name[-5:] == '.html':
            try:
                htmlfile = io.open('./知网html/' + file_name, 'r', encoding='utf-8')
                htmlhandle = htmlfile.read()
                soup = bs(htmlhandle, 'lxml')
                result[file_name] = new  # 第n个文献信息

                # result = pd.DataFrame({}, index=[id]) #存储第n个文献的信息
                # author = {}
                result[file_name]['author'] = []  # {作者：研究机构} 多个作者
                result[file_name]['title'] = ''      # 文章标题
                result[file_name]['abstract'] = ''   # 文献摘要
                result[file_name]['key_wordsZ'] = [] # 多个关键词
                result[file_name]['key_wordsE'] = []
                # author['Institute'] = ''

                content = soup.find('div', class_='top-title')  #解析标题
                # print(content)
                print(content.h1.text)
                result[file_name]['title'] = content.h1.text.replace('"','').replace('\n', '').replace('\r', '')

                data = soup.find('div', class_='data')     #解析摘要
                # print(data)
                print(data.p.text)
                result[file_name]['abstract'] = data.p.text.replace('\n', '').replace('\r', '')

                data = soup.find('div', id='a_keywords')    #解析关键词
                da = soup.find('div', id="a_keywordsEN")
                # print(data)
                a = data.p.text
                b = da.p.text
                print(a)
                print(b)
                #print(a.splitlines()[1])
                for i in a.splitlines():
                    result[file_name]['key_wordsZ'].append(i)
                result[file_name]['key_wordsZ'] = filter(None, result[file_name]['key_wordsZ'])
                for i in b.splitlines():
                    result[file_name]['key_wordsE'].append(i)
                result[file_name]['key_wordsE'] = filter(None, result[file_name]['key_wordsE'])


                content = soup.find('div', class_='content')   #解析作者
                print(content.h2.text)
                for i in content.h2.text.splitlines():
                    result[file_name]['author'].append(i)
                    print(i)
                result[file_name]['author'] = filter(None, result[file_name]['author'])
                #new['author'] = content.h2.text



                with open(output_route + "中文关键词.csv", "a", newline='') as csvfile:  #把关键词写入csv文件
                    writer = csv.writer(csvfile)
                    for i in result[file_name]['key_wordsZ']:
                        list = [str(result[file_name]['title']).replace('\n', '').replace('\r', ''), str(i)]
                        writer.writerow(list)

                with open(output_route + "英文关键词.csv", "a", newline='') as csvfile:  #把关键词写入csv文件
                    writer = csv.writer(csvfile)
                    for i in result[file_name]['key_wordsE']:
                        list = [str(result[file_name]['title']).replace('\n', '').replace('\r', ''),str(i)]
                        writer.writerow(list)

                with open(output_route + "作者.csv", "a", newline='') as csvfile:
                    writer = csv.writer(csvfile)
                    for i in result[file_name]['author']:
                        list = [str(result[file_name]['title']).replace('\n', '').replace('\r', ''), str(i)]
                        writer.writerow(list)


                with open(output_route + "标题摘要.csv", "a", newline='') as csvfile:
                    writer = csv.writer(csvfile)
                    list = [result[file_name]['title'].replace('\n', '').replace('\r', ''), result[file_name]['abstract']]
                    writer.writerow(list)
                print(result)
            except:
                print('异常')
                print(result)
            else:
                pass


with open(output_route + "中文关键词.csv", "r") as csvfile:  #把关键词写入csv文件
    content = csvfile.read()
with open(output_route + "中文关键词.csv", "w", newline='') as csvfile:
    csvfile.write(content.replace('"', '').replace(';',''))


with open(output_route + "英文关键词.csv", "r") as csvfile:  #把关键词写入csv文件
    content = csvfile.read()
with open(output_route + "英文关键词.csv", "w", newline='') as csvfile:
    csvfile.write(content.replace('"', '').replace(';',''))


with open(output_route + "作者.csv", "r") as csvfile:  #把关键词写入csv文件
    content = csvfile.read()
with open(output_route + "作者.csv", "w", newline='') as csvfile:
    csvfile.write(content.replace('"', '').replace(';',''))

with open(output_route + "标题摘要.csv", "r") as csvfile:  #把关键词写入csv文件
    content = csvfile.read()
with open(output_route + "标题摘要.csv", "w", newline='') as csvfile:
    csvfile.write(content.replace('"', '').replace(';',''))